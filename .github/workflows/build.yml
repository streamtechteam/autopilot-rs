name: Build and Release

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # 1. Regular builds for latest systems
  build:
    name: Build - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: autopilot-rs-linux-latest
            asset_name: autopilot-rs-linux
          - os: windows-latest
            artifact_name: autopilot-rs-windows
            asset_name: autopilot-rs-windows.exe
          - os: macos-latest
            artifact_name: autopilot-rs-macos
            asset_name: autopilot-rs-macos

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsystemd-dev libxcb1-dev libxcb1 libxau6 libxau-dev libxrandr2 libxrandr-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release

      - name: Prepare Artifact
        shell: bash
        run: |
          mkdir -p dist
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp target/release/autopilot-rs.exe dist/${{ matrix.asset_name }}
          else
            cp target/release/autopilot-rs dist/${{ matrix.asset_name }}
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.asset_name }}

  # 2. Older glibc Build
  build-linux-compat:
    name: Build Linux (Fedora 35 - glibc 2.34)
    runs-on: ubuntu-latest
    container:
      image: fedora:35
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust and dependencies
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source $HOME/.cargo/env
          dnf install -y gcc systemd-devel libxcb-devel libxcb libXau libXau-devel libXrandr libXrandr-devel

      - name: Build
        run: |
          source $HOME/.cargo/env
          cargo build --release

      - name: Prepare Compatible Binary
        run: |
          mkdir -p dist
          cp target/release/autopilot-rs dist/autopilot-rs-linux-glibc2.17
          # Verify glibc version requirement
          objdump -T dist/autopilot-rs-linux-glibc2.17 | grep GLIBC | sort -u

      - name: Upload Compatible Binary
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-linux-compatible
          path: dist/autopilot-rs-linux-glibc2.17

  # 3. Release Assets
  create-release:
    name: Create Release Assets
    runs-on: ubuntu-latest
    # Add the new jobs to the needs list
    needs: [build, build-linux-compat, build-rpm, build-deb, build-msi,build-arch, build-dmg]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Package for release
        run: |
          mkdir -p release
          # Copy previous binaries
          cp autopilot-rs-linux-latest/autopilot-rs-linux release/
          cp autopilot-rs-windows/autopilot-rs-windows.exe release/

          # Copy new installers
          cp autopilot-rs-msi/*.msi release/
          cp autopilot-rs-arch/*.pkg.tar.zst release/
          cp autopilot-rs-dmg/*.dmg release/
          cp autopilot-rs-rpm/*.rpm release/
          cp autopilot-rs-deb/*.deb release/

          cd release && sha256sum * > SHA256SUMS

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    needs: [build, build-linux-compat]
    container:
      image: fedora:35

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust and dependencies
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          dnf install -y gcc systemd-devel rpm-build cargo

      - name: Build RPM
        run: |
          source $HOME/.cargo/env
          cargo install cargo-rpm || true
          cargo rpm build

      - name: Find RPM
        id: find_rpm
        run: |
          RPM_PATH=$(find target/release/rpmbuild/RPMS -name "*.rpm" | head -1)
          echo "rpm_path=$RPM_PATH" >> $GITHUB_OUTPUT
          echo "rpm_name=$(basename "$RPM_PATH")" >> $GITHUB_OUTPUT

      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-rpm
          path: ${{ steps.find_rpm.outputs.rpm_path }}

  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-latest
    needs: [build, build-linux-compat]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsystemd-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build DEB
        run: cargo deb

      - name: Find DEB
        id: find_deb
        run: |
          DEB_PATH=$(find target/debian -name "*.deb" | head -1)
          echo "deb_path=$DEB_PATH" >> $GITHUB_OUTPUT
          echo "deb_name=$(basename "$DEB_PATH")" >> $GITHUB_OUTPUT

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-deb
          path: ${{ steps.find_deb.outputs.deb_path }}


  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm base-devel rust cargo git sudo systemd-libs libxcb libxrandr libx11 libxau
      - uses: actions/checkout@v4
      - name: Build Package
        run: |
          # Create builduser
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Fix permissions so builduser can read the workspace
          chown -R builduser:builduser .

          # Run makepkg.
          # --nodeps is used here because we already installed dependencies above
          sudo -u builduser makepkg -sc --noconfirm
      - name: Upload Arch Artifact
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-arch
          path: "*.pkg.tar.zst"
  build-msi:
    name: Build Windows MSI
    runs-on: windows-latest
    # We no longer strictly "need" the other build job if we build here
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build and Package MSI
        run: cargo wix

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-msi
          path: target/wix/*.msi

  build-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Build Binary
        run: cargo build --release
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Create DMG
        run: |
          mkdir -p dist
          cp target/release/autopilot-rs dist/
          create-dmg \
            --volname "Autopilot Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "autopilot-rs" 200 190 \
            --hide-extension "autopilot-rs" \
            --app-drop-link 600 185 \
            "autopilot-rs.dmg" \
            "dist/"
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-rs-dmg
          path: "*.dmg"
